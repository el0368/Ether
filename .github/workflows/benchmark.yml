name: Benchmark

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  benchmark:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.18'
          otp-version: '27'
      
      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: '0.15.2'
      
      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-${{ hashFiles('**/mix.lock') }}
          restore-keys: ${{ runner.os }}-mix-
      
      - name: Install dependencies
        run: mix deps.get
      
      - name: Compile project
        run: mix compile
      
      - name: Build NIF
        run: |
          cd native/scanner
          zig build -Doptimize=ReleaseSafe
          cd ../..
          Copy-Item -Path "native/scanner/zig-out/bin/scanner_nif.dll" -Destination "priv/native/scanner_nif.dll" -Force
      
      - name: Run benchmarks
        id: bench
        run: |
          mix run -e "Ether.Benchmark.run(ci: true)"
      
      - name: Read benchmark results
        id: results
        shell: pwsh
        run: |
          $results = Get-Content bench/ci_results.json | ConvertFrom-Json
          echo "zig_ops_sec=$($results.result.zig_ops_sec)" >> $env:GITHUB_OUTPUT
          echo "elixir_ops_sec=$($results.result.elixir_ops_sec)" >> $env:GITHUB_OUTPUT
          echo "speedup=$($results.result.speedup)" >> $env:GITHUB_OUTPUT
          
          $regression = if ($results.status -is [hashtable] -and $results.status.Keys -contains 'regression') { 'true' } else { 'false' }
          echo "regression=$regression" >> $env:GITHUB_OUTPUT
      
      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('bench/ci_results.json', 'utf8'));
            
            let status = 'âœ… Performance OK';
            let emoji = 'âœ…';
            
            if (results.status && results.status.regression) {
              status = `âš ï¸ Performance regression detected: ${(results.status.regression * 100).toFixed(1)}% slower`;
              emoji = 'âš ï¸';
            } else if (results.status && results.status.improvement) {
              status = `ğŸš€ Performance improvement: ${(results.status.improvement * 100).toFixed(1)}% faster`;
              emoji = 'ğŸš€';
            }
            
            const comment = `## ${emoji} Benchmark Results
            
            | Metric | Value |
            |--------|-------|
            | **Elixir** | ${results.result.elixir_ops_sec} ops/sec |
            | **Zig NIF** | ${results.result.zig_ops_sec} ops/sec |
            | **Speedup** | ${results.result.speedup}x |
            
            ${status}
            
            <details>
            <summary>Threshold</summary>
            
            - Regression threshold: ${(results.threshold * 100)}%
            - Baseline comparison: ${results.status === 'no_baseline' ? 'No baseline set' : 'Compared against baseline'}
            </details>
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Fail on regression
        if: steps.results.outputs.regression == 'true'
        run: |
          echo "::error::Performance regression detected!"
          exit 1
